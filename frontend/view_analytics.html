<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam Analytics - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-weight: 500;
        }
        .badge-active { background-color: #d1fae5; color: #065f46; }
        .badge-draft { background-color: #fef3c7; color: #92400e; }
        .badge-archived { background-color: #d1d5db; color: #4b5563; }
        .badge-completed { background-color: #bfdbfe; color: #1e40af; }
        .badge-scheduled { background-color: #c7d2fe; color: #4338ca; }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="flex h-screen bg-gray-50">
        <aside class="w-64 bg-white shadow-lg p-6 flex flex-col justify-between">
            <div>
                <div class="text-2xl font-bold text-gray-800 mb-8">Exam Dashboard</div>
                <nav class="space-y-4">
                    <a href="/admin_dashboard.html" class="flex items-center space-x-3 text-gray-600 hover:text-blue-600 hover:bg-gray-100 p-3 rounded-lg transition-colors duration-200">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-2v2m-4-2v2M6 8V6a2 2 0 012-2h10a2 2 0 012 2v10a2 2 0 01-2 2H8a2 2 0 01-2-2v-2m4 0a2 2 0 100-4 2 2 0 000 4z"></path></svg>
                        <span>Dashboard</span>
                    </a>
                    <a href="/add_exam.html" class="flex items-center space-x-3 text-gray-600 hover:text-blue-600 hover:bg-gray-100 p-3 rounded-lg transition-colors duration-200">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                        <span>Add New Exam</span>
                    </a>
                    <a href="#" class="flex items-center space-x-3 text-blue-600 bg-gray-100 p-3 rounded-lg transition-colors duration-200">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0h6"></path></svg>
                        <span>Analytics</span>
                    </a>
                    <a href="#" class="flex items-center space-x-3 text-gray-600 hover:text-blue-600 hover:bg-gray-100 p-3 rounded-lg transition-colors duration-200">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                        <span>Logout</span>
                    </a>
                </nav>
            </div>
            <div class="text-sm text-gray-500 text-center">
                Â© 2023 Exam Dashboard
            </div>
        </aside>

        <main class="flex-1 p-8 overflow-y-auto">
            <header class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-gray-900">Exam Analytics</h1>
            </header>

            <section class="bg-white p-6 rounded-xl shadow-md mb-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-semibold text-gray-800" id="examTitle">Exam Title</h2>
                    <span id="examStatus" class="badge badge-draft">Draft</span>
                </div>
                <p class="text-gray-500 mb-4" id="examSubject"></p>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mt-4">
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <p class="text-sm text-gray-500">Average Score</p>
                        <p class="text-2xl font-bold text-gray-800" id="avgScore">N/A</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <p class="text-sm text-gray-500">Pass Rate</p>
                        <p class="text-2xl font-bold text-gray-800" id="passRate">N/A</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <p class="text-sm text-gray-500">Enrolled Students</p>
                        <p class="text-2xl font-bold text-gray-800" id="enrolledStudents">N/A</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <p class="text-sm text-gray-500">Completions</p>
                        <p class="text-2xl font-bold text-gray-800" id="completions">N/A</p>
                    </div>
                </div>
            </section>

            <section class="bg-white p-6 rounded-xl shadow-md">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Activity Feed</h2>
                <div id="activityFeed" class="space-y-4">
                    </div>
            </section>
        </main>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:3000/api';

        const urlParams = new URLSearchParams(window.location.search);
        const examId = urlParams.get('examId');
        
        const examTitleEl = document.getElementById('examTitle');
        const examSubjectEl = document.getElementById('examSubject');
        const examStatusEl = document.getElementById('examStatus');
        const avgScoreEl = document.getElementById('avgScore');
        const passRateEl = document.getElementById('passRate');
        const enrolledStudentsEl = document.getElementById('enrolledStudents');
        const completionsEl = document.getElementById('completions');
        const activityFeedEl = document.getElementById('activityFeed');

        const statusBadgeClasses = {
            'Active': 'badge badge-active',
            'Draft': 'badge badge-draft',
            'Completed': 'badge badge-completed',
            'Scheduled': 'badge badge-scheduled',
            'Archived': 'badge badge-archived'
        };

        async function fetchExamAnalytics() {
            if (!examId) {
                examTitleEl.textContent = 'Exam Not Found';
                return;
            }

            try {
                // Fetch Exam Details
                const examResponse = await fetch(`${API_BASE_URL}/exams/${examId}`);
                if (!examResponse.ok) {
                    throw new Error(`HTTP error! status: ${examResponse.status}`);
                }
                const exam = await examResponse.json();

                // Populate Exam Details
                const examStatus = exam.status || 'Draft';
                examTitleEl.textContent = exam.title;
                examSubjectEl.textContent = `Subject: ${exam.subject}`;
                examStatusEl.textContent = examStatus;
                examStatusEl.className = statusBadgeClasses[examStatus] || 'badge badge-draft';

                // Populate Analytics Data
                avgScoreEl.textContent = exam.avgScore ? `${exam.avgScore}%` : 'N/A';
                passRateEl.textContent = exam.passRate ? `${exam.passRate}%` : 'N/A';
                enrolledStudentsEl.textContent = exam.enrolledStudents || 'N/A';
                completionsEl.textContent = `${exam.completions || 'N/A'}/${exam.enrolledStudents || 'N/A'}`;

                // Fetch Activity Feed
                const activityResponse = await fetch(`${API_BASE_URL}/activity`);
                if (!activityResponse.ok) {
                    throw new Error(`HTTP error! status: ${activityResponse.status}`);
                }
                const activityFeed = await activityResponse.json();

                // Render Activity Feed
                renderActivityFeed(activityFeed);

            } catch (error) {
                console.error("Error fetching analytics:", error);
                examTitleEl.textContent = 'Failed to load analytics';
            }
        }

        function renderActivityFeed(activities) {
            activityFeedEl.innerHTML = '';
            if (activities.length === 0) {
                activityFeedEl.innerHTML = '<p class="text-gray-500">No recent activity.</p>';
                return;
            }

            activities.forEach(item => {
                const activityItem = document.createElement('div');
                activityItem.className = 'flex items-start space-x-3 bg-gray-50 p-4 rounded-lg border border-gray-200';
                activityItem.innerHTML = `
                    <div class="flex-shrink-0 w-8 h-8 flex items-center justify-center rounded-full bg-blue-100 text-blue-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    </div>
                    <div class="flex-1">
                        <p class="text-gray-800">${item.message}</p>
                        <p class="text-sm text-gray-500">${new Date(item.timestamp).toLocaleString()}</p>
                    </div>
                `;
                activityFeedEl.appendChild(activityItem);
            });
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', fetchExamAnalytics);
    </script>
</body>
</html>